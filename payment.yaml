---
- name: setup payment
  hosts: payment.devops-project.co.uk
  become: yes

  tasks:
   - name: installing oython3, gcc, python-devel
     ansible.builtin.package:
       name: "{{ item }}"
       state: present
     loop:
      - python3
      - gcc
      - python3-devel

   - name: create user
     ansible.builtin.user:
       name: roboshop
       state: present
       system: true
       comment: system user
       home: /app
       shell: /sbin/nologin

   - name: create folder
     ansible.builtin.file:
       path: /app
       state: directory

   - name: download code
     ansible.builtin.get_url:
       url: "https://roboshop-artifacts.s3.amazonaws.com/payment-v3.zip"
       dest: /tmp/user.zip

   - name: unzip
     ansible.builtin.unarchive:
       src: /tmp/payment.zip
       dest: /app
       remote_src: yes

   - name: install dependencies
     ansible.builtin.pip:
       requirements: /app/requirements.txt
       executable: pip3

   - name: craete systemd service
     ansible.builtin.copy:
       src: payment.service
       dest: /etc/systemd/system/payment.service

   - name: start and enable service
     ansible.builtin.systemd_service:
       name: payment
       state: started
       daemon-reload: true
       enabled: yes